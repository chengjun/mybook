

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Causal Forests &#8212; 计算传播学</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script async="async" kind="hypothesis" src="https://hypothes.is/embed.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '09-grf';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="第七章 神经网络与深度学习" href="09-11-neural-network-intro.html" />
    <link rel="prev" title="The future of employment" href="09-10-future-employment.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/socrates_jump.gif" class="logo__image only-light" alt="计算传播学 - Home"/>
    <script>document.write(`<img src="_static/socrates_jump.gif" class="logo__image only-dark" alt="计算传播学 - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    寻找人类传播行为的基因
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="01-intro2cjc.html">第一章 计算传播学简介</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="02-bigdata.html">数据科学的编程工具：大数据</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="03-python-intro.html">第二章 数据科学的编程工具</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="0-jupyter-notebook.html">Jupyter Notebook</a></li>
<li class="toctree-l2"><a class="reference internal" href="0-chatgpt.html">Using ChatGPT to Learn Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="0-iching.html">iching: A python package of I Ching</a></li>
<li class="toctree-l2"><a class="reference internal" href="01-recombination.html">计算思维：通过拆解和重组学习</a></li>
<li class="toctree-l2"><a class="reference internal" href="0-slides.html">使用Jupyter制作Slides的介绍</a></li>
<li class="toctree-l2"><a class="reference internal" href="0-turicreate.html">Turicreate: Departure from Graphlab</a></li>
<li class="toctree-l2"><a class="reference internal" href="0-matplotlib-chinese.html">解决Matplotlib绘图显示中文问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="03-UK-MPS-Scandal.html">案例：2009年英国国会议员开支丑闻</a></li>
<li class="toctree-l2"><a class="reference internal" href="03-umbrella-of-love.html">案例：《转角遇到爱》背后的数据</a></li>
<li class="toctree-l2"><a class="reference internal" href="03-who-runs-China.html">案例：Who runs China？背后的数据</a></li>
<li class="toctree-l2"><a class="reference internal" href="03-gdelt.html">Gdelt Dataset: Events, Mentions, and Global Knowledge Graph</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="04-crawler-beautifulsoup.html">第三章 数据抓取</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="04-crawler-fact-checking.html">抓取实时辟谣数据</a></li>
<li class="toctree-l2"><a class="reference internal" href="04-crawler-13chambers.html">抓取网络小说</a></li>
<li class="toctree-l2"><a class="reference internal" href="04-crawler-wechat.html">抓取微信公众号文章内容</a></li>
<li class="toctree-l2"><a class="reference internal" href="04-crawler-douban.html">使用requests + Xpath抓取豆瓣电影数据</a></li>
<li class="toctree-l2"><a class="reference internal" href="04-crawler-gov-report.html">抓取历届政府工作报告</a></li>
<li class="toctree-l2"><a class="reference internal" href="04-crawler-cppcc.html">抓取江苏省政协十年提案</a></li>
<li class="toctree-l2"><a class="reference internal" href="04-crawler-netease-music.html">抓取网易云音乐热门评论</a></li>
<li class="toctree-l2"><a class="reference internal" href="04-crawler-selenium.html">使用Selenium操纵浏览器</a></li>
<li class="toctree-l2"><a class="reference internal" href="04-crawler-selenium-music-history.html">抓取网易云音乐用户的听歌记录</a></li>
<li class="toctree-l2"><a class="reference internal" href="04-crawler-selenium-people-com-search.html">使用Selenium提取人民网搜索数据</a></li>
<li class="toctree-l2"><a class="reference internal" href="04-crawler-tripadvisor.html">使用Selenium抓取TripAdvisor用户评论</a></li>
<li class="toctree-l2"><a class="reference internal" href="04-crawler-pyppeteer.html">使用Pyppeteer实现异步抓取!</a></li>
<li class="toctree-l2"><a class="reference internal" href="04-crawler-weibo.html">轻型微博爬虫</a></li>
<li class="toctree-l2"><a class="reference internal" href="04-crawler-snscrape-twitter.html">snscrape</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="06-data-cleaning-intro.html">第四章 数据清洗</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="06-data-cleaning-preprocessing.html">对大数据进行预处理</a></li>
<li class="toctree-l2"><a class="reference internal" href="06-data-cleaning-tweets.html">数据清洗之推特数据</a></li>
<li class="toctree-l2"><a class="reference internal" href="06-data-cleaning-occupy-central-news.html">对占中新闻进行数据清洗</a></li>
<li class="toctree-l2"><a class="reference internal" href="06-data-cleaning-music-list.html">清洗音乐列表🎵</a></li>
<li class="toctree-l2"><a class="reference internal" href="06-data-cleaning-pandas.html">使用Pandas进行数据清洗</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="08-01-statistics-thinking.html">第五章 统计思维</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="08-02-kl-divergence.html">KL Divergence</a></li>
<li class="toctree-l2"><a class="reference internal" href="08-02-linear-algebra.html">Linear algebra</a></li>
<li class="toctree-l2"><a class="reference internal" href="08-03-distributions.html">Distribution Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="08-03-probability.html">Probability</a></li>
<li class="toctree-l2"><a class="reference internal" href="08-04-hypothesis-inference.html">Statistical Hypothesis Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="08-05-gradient-descent.html">Introduction to Gradient Descent</a></li>
<li class="toctree-l2"><a class="reference internal" href="08-06-regression.html">Linear Regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="08-06-statsmodels.html">Statistical Modeling with Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="08-07-analyzing-titanic-dataset.html">Logistic Regression of Titanic Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="08-07-covid19-pew-survey.html">Analysing the Pew Survey Data of COVID19</a></li>
<li class="toctree-l2"><a class="reference internal" href="08-11-cfps-survey-analysis.html">中国家庭追踪调查2018</a></li>
<li class="toctree-l2"><a class="reference internal" href="08-08-covid19-grangercausality.html">社交媒体可以预测新冠疫情吗？</a></li>
<li class="toctree-l2"><a class="reference internal" href="08-09-survival-analysis.html">Survival Analysis with Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="08-10-dowhy-estimation-methods.html">The Book of Why</a></li>

</ul>
</li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="09-01-machine-learning-with-sklearn.html">第六章 社会科学家的机器学习</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="09-03-hyperparameters-and-model-validation.html">Hyperparameters and Model Validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="09-04-feature-engineering.html">Feature Engineering</a></li>
<li class="toctree-l2"><a class="reference internal" href="09-05-naive-bayes.html">In Depth: Naive Bayes Classification</a></li>
<li class="toctree-l2"><a class="reference internal" href="09-06-linear-regression.html">In Depth: Linear Regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="09-07-support-vector-machines.html">In-Depth: Support Vector Machines</a></li>
<li class="toctree-l2"><a class="reference internal" href="09-08-random-forests.html">In-Depth: Decision Trees and Random Forests</a></li>
<li class="toctree-l2"><a class="reference internal" href="09-09-googleflustudy.html">Forecasting and nowcasting with Google Flu Trends</a></li>
<li class="toctree-l2"><a class="reference internal" href="09-10-future-employment.html">The future of employment</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Causal Forests</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="09-11-neural-network-intro.html">第七章 神经网络与深度学习</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="09-13-cnn.html">Convolutional Networks</a></li>
<li class="toctree-l2"><a class="reference internal" href="09-14-rnn.html">Sequnce Modeling: Recurrent and Recursive Nets</a></li>
<li class="toctree-l2"><a class="reference internal" href="09-12-hand-written-digits.html">Recognizing Hand-Written Digits with Neural Networks</a></li>
<li class="toctree-l2"><a class="reference internal" href="09-15-cifar10.html">使用CNN对CIFAR10图像进行分类</a></li>
<li class="toctree-l2"><a class="reference internal" href="09-16-pytorch_vgg_pretrained.html">VGG16预训练模型</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="10-text-mining-gov-report.html">第八章 文本挖掘</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-8"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="10-word2vec.html">词向量模型简介</a></li>
<li class="toctree-l2"><a class="reference internal" href="10-doc2vec.html">Doc2Vec</a></li>
<li class="toctree-l2"><a class="reference internal" href="11-1-sentiment-analysis-with-dict.html">基于字典的情感分析</a></li>
<li class="toctree-l2"><a class="reference internal" href="11-2-emotion-dict.html">大连理工大学中文情感词汇</a></li>
<li class="toctree-l2"><a class="reference internal" href="11-3-NRC-Chinese-dict.html">基于NRC字典的情感分析</a></li>
<li class="toctree-l2"><a class="reference internal" href="11-3-textblob.html">利用textblob进行情感分析</a></li>
<li class="toctree-l2"><a class="reference internal" href="11-4-sentiment-classifier.html">基于机器学习的情感分析</a></li>
<li class="toctree-l2"><a class="reference internal" href="11-5-LIWC.html">LIWC: Linguistic Inquiry and Word Count  analyzer</a></li>
<li class="toctree-l2"><a class="reference internal" href="11-6-moral-foundation-dict.html">Moral Foundation Dictionary</a></li>
<li class="toctree-l2"><a class="reference internal" href="12-topic-models-update.html">主题模型简介</a></li>
<li class="toctree-l2"><a class="reference internal" href="12-topic-models-with-turicreate.html">使用Turicreate建立主题模型</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="13-recsys-intro.html">第九章 推荐系统简介</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-9"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="13-recsys-latent-factor-model.html">Latent Factor Recommender System</a></li>
<li class="toctree-l2"><a class="reference internal" href="13-recsys-intro-surprise.html">使用Surprise构建推荐系统</a></li>
<li class="toctree-l2"><a class="reference internal" href="14-millionsong.html">使用Turicreate进行音乐推荐</a></li>
<li class="toctree-l2"><a class="reference internal" href="14-movielens.html">使用Turicreate进行电影推荐</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="15-network-science-intro.html">第十章 网络科学简介</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-10"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="16-network-science-models.html">网络科学模型</a></li>
<li class="toctree-l2"><a class="reference internal" href="17-networkx.html">使用NetworkX分析网络</a></li>
<li class="toctree-l2"><a class="reference internal" href="18-02-network-diffusion.html">Simulating Network Diffusion With NDlib</a></li>
<li class="toctree-l2"><a class="reference internal" href="18-03-network-epidemics.html">Epidemics on Networks</a></li>
<li class="toctree-l2"><a class="reference internal" href="18-04-seir-hcd-model.html">SEIR-HCD Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="18-network-ergm-siena.html">Social Network Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="18-network-weibo-hot-search.html">微博热搜分析</a></li>
<li class="toctree-l2"><a class="reference internal" href="18-network-analysis-of-tianya-bbs.html">天涯论坛的回帖网络分析</a></li>
<li class="toctree-l2"><a class="reference internal" href="19-facebook-ego-netwrok-visualization.html">可视化Facebook社交网络</a></li>
<li class="toctree-l2"><a class="reference internal" href="18-network-ecomplexity.html">Economic Complexity and Product Complexity</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="19-visualization-with-seaborn.html">第十一章 可视化</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-11"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="19-visualization-matplotlib-colormap.html">Qualitative Colormaps in Matplotlib Visualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="19-visualization-scientific-plot.html">Matplotlib的科学绘图样式</a></li>
<li class="toctree-l2"><a class="reference internal" href="19-visualization-with-pyecharts.html">使用PyEcharts进行可视化</a></li>
<li class="toctree-l2"><a class="reference internal" href="19-visualization-plotly-express.html">Plotly Express in Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="19-visualization-maps-using-folium.html">使用folium做地图可视化</a></li>
<li class="toctree-l2"><a class="reference internal" href="19-visualization-datashader.html">使用Datashader可视化地理信息</a></li>
<li class="toctree-l2"><a class="reference internal" href="19-visualization-datapane.html">使用Datapane制作数据报告</a></li>
<li class="toctree-l2"><a class="reference internal" href="19-visualization-pantheon.html">万神殿项目（Pantheon Project）</a></li>
</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/chengjun/mybook/blob/main/09-grf.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/chengjun/mybook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/chengjun/mybook/issues/new?title=Issue%20on%20page%20%2F09-grf.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/09-grf.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Causal Forests</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="causal-forests">
<h1>Causal Forests<a class="headerlink" href="#causal-forests" title="Permalink to this heading">#</a></h1>
<p><a class="github reference external" href="https://github.com/grf-labs/grf/blob/master/experiments/acic18/script.R">grf-labs/grf</a></p>
<p><a class="github reference external" href="https://github.com/grf-labs/grf/tree/master/experiments/acic18">grf-labs/grf</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">install.packages</span><span class="p">(</span><span class="s">&#39;grf&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The downloaded binary packages are in
	/var/folders/8b/hhnbt0nd4zsg2qhxc28q23w80000gn/T//RtmpydKe1A/downloaded_packages
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="s">&#39;grf&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning message:
“package ‘grf’ was built under R version 3.6.2”
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">if</span><span class="p">(</span><span class="nf">packageVersion</span><span class="p">(</span><span class="s">&quot;grf&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="s">&#39;0.10.2&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nf">warning</span><span class="p">(</span><span class="s">&quot;This script requires grf 0.10.2 or higher&quot;</span><span class="p">)</span>
<span class="p">}</span>
<span class="nf">library</span><span class="p">(</span><span class="n">sandwich</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">lmtest</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">Hmisc</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">set.seed</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>

<span class="nf">rm</span><span class="p">(</span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ls</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">data.all</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">read.csv</span><span class="p">(</span><span class="s">&quot;./data/synthetic_data.csv&quot;</span><span class="p">)</span>
<span class="n">data.all</span><span class="o">$</span><span class="n">schoolid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">factor</span><span class="p">(</span><span class="n">data.all</span><span class="o">$</span><span class="n">schoolid</span><span class="p">)</span>

<span class="n">DF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data.all</span><span class="p">[,</span><span class="m">-1</span><span class="p">]</span>
<span class="n">school.id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">data.all</span><span class="o">$</span><span class="n">schoolid</span><span class="p">)</span>

<span class="n">school.mat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">model.matrix</span><span class="p">(</span><span class="o">~</span><span class="w"> </span><span class="n">schoolid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data.all</span><span class="p">)</span>
<span class="n">school.size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">colSums</span><span class="p">(</span><span class="n">school.mat</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># It appears that school ID does not affect pscore. So ignore it</span>
<span class="c1"># in modeling, and just treat it as source of per-cluster error.</span>
<span class="n">w.lm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">glm</span><span class="p">(</span><span class="n">Z</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">.</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data.all</span><span class="p">[,</span><span class="m">-3</span><span class="p">],</span><span class="w"> </span><span class="n">family</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">binomial</span><span class="p">)</span>
<span class="nf">summary</span><span class="p">(</span><span class="n">w.lm</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Call:
glm(formula = Z ~ ., family = binomial, data = data.all[, -3])

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-1.2079  -0.9088  -0.8297   1.4176   1.9556  

Coefficients: (6 not defined because of singularities)
              Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept) -0.9524636  0.2845173  -3.348 0.000815 ***
schoolid2    0.0697302  0.2766287   0.252 0.800986    
schoolid3    0.0382080  0.2911323   0.131 0.895586    
schoolid4    0.1761334  0.2784711   0.633 0.527059    
schoolid5   -0.0033389  0.2950180  -0.011 0.990970    
schoolid6    0.0583548  0.3067481   0.190 0.849124    
schoolid7   -0.1313759  0.3188190  -0.412 0.680288    
schoolid8    0.1233661  0.3023736   0.408 0.683279    
schoolid9   -0.1955428  0.3073344  -0.636 0.524611    
schoolid10  -0.1892794  0.2968750  -0.638 0.523752    
schoolid11  -0.2224060  0.5461005  -0.407 0.683816    
schoolid12  -0.3312420  0.5414374  -0.612 0.540682    
schoolid13  -0.0408540  0.3989507  -0.102 0.918436    
schoolid14  -0.8681934  0.6033674  -1.439 0.150175    
schoolid15  -0.1059135  0.3263162  -0.325 0.745504    
schoolid16  -0.1063268  0.2885387  -0.369 0.712500    
schoolid17   0.0854323  0.3119435   0.274 0.784184    
schoolid18  -0.1924441  0.2997822  -0.642 0.520908    
schoolid19  -0.0265326  0.3229712  -0.082 0.934526    
schoolid20  -0.2179554  0.3041336  -0.717 0.473594    
schoolid21  -0.2147440  0.2982822  -0.720 0.471565    
schoolid22  -0.5115966  0.4410779  -1.160 0.246098    
schoolid23   0.0039231  0.3475373   0.011 0.990994    
schoolid24  -0.0848314  0.3259572  -0.260 0.794668    
schoolid25   0.0521087  0.2754586   0.189 0.849959    
schoolid26   0.0241212  0.2876511   0.084 0.933171    
schoolid27  -0.2300630  0.3104796  -0.741 0.458698    
schoolid28  -0.3519010  0.2924774  -1.203 0.228909    
schoolid29  -0.2198764  0.3293288  -0.668 0.504357    
schoolid30  -0.3146292  0.3257994  -0.966 0.334187    
schoolid31   0.1398555  0.6137901   0.228 0.819759    
schoolid32   0.1555524  0.3916156   0.397 0.691215    
schoolid33  -0.0991693  0.3939370  -0.252 0.801243    
schoolid34  -0.0073688  0.2980808  -0.025 0.980278    
schoolid35  -0.3528987  0.3997273  -0.883 0.377318    
schoolid36  -0.3751465  0.3988972  -0.940 0.346982    
schoolid37  -0.0343169  0.3219646  -0.107 0.915117    
schoolid38  -0.1346432  0.3851869  -0.350 0.726674    
schoolid39  -0.4339936  0.3612869  -1.201 0.229657    
schoolid40  -0.3993958  0.3834495  -1.042 0.297604    
schoolid41  -0.1490784  0.3542105  -0.421 0.673846    
schoolid42  -0.1545715  0.3551857  -0.435 0.663428    
schoolid43  -0.5679567  0.4277455  -1.328 0.184247    
schoolid44  -0.1425896  0.3774795  -0.378 0.705623    
schoolid45  -0.1337888  0.3232493  -0.414 0.678957    
schoolid46  -0.2573249  0.3129119  -0.822 0.410874    
schoolid47   0.0027726  0.2770108   0.010 0.992014    
schoolid48  -0.3406079  0.3470361  -0.981 0.326358    
schoolid49  -0.3236117  0.3434541  -0.942 0.346077    
schoolid50  -0.1185119  0.4086074  -0.290 0.771787    
schoolid51   0.4087898  0.4506822   0.907 0.364382    
schoolid52  -0.3144014  0.4118342  -0.763 0.445214    
schoolid53  -0.2733677  0.4511280  -0.606 0.544538    
schoolid54  -0.0889588  0.3872532  -0.230 0.818311    
schoolid55  -0.1558106  0.4155020  -0.375 0.707665    
schoolid56   0.1050353  0.3149235   0.334 0.738737    
schoolid57  -0.0314901  0.2901719  -0.109 0.913581    
schoolid58  -0.0383183  0.2730077  -0.140 0.888379    
schoolid59  -0.0529637  0.2934895  -0.180 0.856790    
schoolid60  -0.1624792  0.3972885  -0.409 0.682561    
schoolid61  -0.0289549  0.3201953  -0.090 0.927946    
schoolid62   0.0993158  0.2669678   0.372 0.709882    
schoolid63   0.1684702  0.3282167   0.513 0.607749    
schoolid64  -0.0693060  0.2770896  -0.250 0.802493    
schoolid65  -0.0004197  0.4072922  -0.001 0.999178    
schoolid66  -0.2130911  0.2984091  -0.714 0.475171    
schoolid67   0.0358440  0.2921158   0.123 0.902341    
schoolid68  -0.0871303  0.3290814  -0.265 0.791188    
schoolid69  -0.2550387  0.2908992  -0.877 0.380636    
schoolid70  -0.0268947  0.4032160  -0.067 0.946820    
schoolid71   0.0037464  0.4268290   0.009 0.992997    
schoolid72  -0.1304085  0.2881512  -0.453 0.650859    
schoolid73  -0.2160697  0.2840030  -0.761 0.446776    
schoolid74  -0.0935320  0.2842612  -0.329 0.742129    
schoolid75  -0.1056241  0.3024204  -0.349 0.726892    
schoolid76  -0.1052261  0.2939262  -0.358 0.720342    
S3           0.1036077  0.0197345   5.250 1.52e-07 ***
C1          -0.0015919  0.0053900  -0.295 0.767728    
C2          -0.1038596  0.0424020  -2.449 0.014309 *  
C3          -0.1319218  0.0461833  -2.856 0.004284 ** 
XC                  NA         NA      NA       NA    
X1                  NA         NA      NA       NA    
X2                  NA         NA      NA       NA    
X3                  NA         NA      NA       NA    
X4                  NA         NA      NA       NA    
X5                  NA         NA      NA       NA    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 13115  on 10390  degrees of freedom
Residual deviance: 13009  on 10311  degrees of freedom
AIC: 13169

Number of Fisher Scoring iterations: 4
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">W</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DF</span><span class="o">$</span><span class="n">Z</span>
<span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DF</span><span class="o">$</span><span class="n">Y</span>
<span class="n">X.raw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DF</span><span class="p">[,</span><span class="o">-</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">2</span><span class="p">)]</span>

<span class="n">C1.exp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">model.matrix</span><span class="p">(</span><span class="o">~</span><span class="w"> </span><span class="nf">factor</span><span class="p">(</span><span class="n">X.raw</span><span class="o">$</span><span class="n">C1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">0</span><span class="p">)</span>
<span class="n">XC.exp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">model.matrix</span><span class="p">(</span><span class="o">~</span><span class="w"> </span><span class="nf">factor</span><span class="p">(</span><span class="n">X.raw</span><span class="o">$</span><span class="n">XC</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">0</span><span class="p">)</span>

<span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">cbind</span><span class="p">(</span><span class="n">X.raw</span><span class="p">[,</span><span class="o">-</span><span class="nf">which</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="n">X.raw</span><span class="p">)</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;C1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;XC&quot;</span><span class="p">))],</span><span class="w"> </span><span class="n">C1.exp</span><span class="p">,</span><span class="w"> </span><span class="n">XC.exp</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">#</span>
<span class="c1"># Grow a forest. Add extra trees for the causal forest.</span>
<span class="c1">#</span>

<span class="n">Y.forest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">regression_forest</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">Y</span><span class="p">,</span><span class="w"> </span><span class="n">clusters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">school.id</span><span class="p">,</span><span class="w"> </span><span class="n">equalize.cluster.weights</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span>
<span class="n">Y.hat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="n">Y.forest</span><span class="p">)</span><span class="o">$</span><span class="n">predictions</span>
<span class="n">W.forest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">regression_forest</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">W</span><span class="p">,</span><span class="w"> </span><span class="n">clusters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">school.id</span><span class="p">,</span><span class="w"> </span><span class="n">equalize.cluster.weights</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span>
<span class="n">W.hat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="n">W.forest</span><span class="p">)</span><span class="o">$</span><span class="n">predictions</span>

<span class="n">cf.raw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">causal_forest</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">Y</span><span class="p">,</span><span class="w"> </span><span class="n">W</span><span class="p">,</span>
<span class="w">                       </span><span class="n">Y.hat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Y.hat</span><span class="p">,</span><span class="w"> </span><span class="n">W.hat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">W.hat</span><span class="p">,</span>
<span class="w">                       </span><span class="n">clusters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">school.id</span><span class="p">,</span>
<span class="w">                       </span><span class="n">equalize.cluster.weights</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span>
<span class="n">varimp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">variable_importance</span><span class="p">(</span><span class="n">cf.raw</span><span class="p">)</span>
<span class="n">selected.idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">which</span><span class="p">(</span><span class="n">varimp</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nf">mean</span><span class="p">(</span><span class="n">varimp</span><span class="p">))</span>

<span class="n">cf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">causal_forest</span><span class="p">(</span><span class="n">X</span><span class="p">[,</span><span class="n">selected.idx</span><span class="p">],</span><span class="w"> </span><span class="n">Y</span><span class="p">,</span><span class="w"> </span><span class="n">W</span><span class="p">,</span>
<span class="w">                   </span><span class="n">Y.hat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Y.hat</span><span class="p">,</span><span class="w"> </span><span class="n">W.hat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">W.hat</span><span class="p">,</span>
<span class="w">                   </span><span class="n">clusters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">school.id</span><span class="p">,</span>
<span class="w">                   </span><span class="n">equalize.cluster.weights</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span>
<span class="w">                   </span><span class="n">tune.parameters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;all&quot;</span><span class="p">)</span>
<span class="n">tau.hat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="n">cf</span><span class="p">)</span><span class="o">$</span><span class="n">predictions</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">#</span>
<span class="c1"># Estimate ATE</span>
<span class="c1">#</span>

<span class="n">ATE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">average_treatment_effect</span><span class="p">(</span><span class="n">cf</span><span class="p">)</span>
<span class="nf">paste</span><span class="p">(</span><span class="s">&quot;95% CI for the ATE:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="n">ATE</span><span class="p">[</span><span class="m">1</span><span class="p">],</span><span class="w"> </span><span class="m">3</span><span class="p">),</span>
<span class="w">      </span><span class="s">&quot;+/-&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="nf">qnorm</span><span class="p">(</span><span class="m">0.975</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ATE</span><span class="p">[</span><span class="m">2</span><span class="p">],</span><span class="w"> </span><span class="m">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">'95% CI for the ATE: 0.249 +/- 0.04'</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">#</span>
<span class="c1"># Omnibus tests for heterogeneity</span>
<span class="c1">#</span>

<span class="c1"># Run best linear predictor analysis</span>
<span class="nf">test_calibration</span><span class="p">(</span><span class="n">cf</span><span class="p">)</span>

<span class="c1"># Compare regions with high and low estimated CATEs</span>
<span class="n">high_effect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tau.hat</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nf">median</span><span class="p">(</span><span class="n">tau.hat</span><span class="p">)</span>
<span class="n">ate.high</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">average_treatment_effect</span><span class="p">(</span><span class="n">cf</span><span class="p">,</span><span class="w"> </span><span class="n">subset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">high_effect</span><span class="p">)</span>
<span class="n">ate.low</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">average_treatment_effect</span><span class="p">(</span><span class="n">cf</span><span class="p">,</span><span class="w"> </span><span class="n">subset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="n">high_effect</span><span class="p">)</span>
<span class="nf">paste</span><span class="p">(</span><span class="s">&quot;95% CI for difference in ATE:&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nf">round</span><span class="p">(</span><span class="n">ate.high</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ate.low</span><span class="p">[</span><span class="m">1</span><span class="p">],</span><span class="w"> </span><span class="m">3</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;+/-&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nf">round</span><span class="p">(</span><span class="nf">qnorm</span><span class="p">(</span><span class="m">0.975</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">sqrt</span><span class="p">(</span><span class="n">ate.high</span><span class="p">[</span><span class="m">2</span><span class="p">]</span><span class="o">^</span><span class="m">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ate.low</span><span class="p">[</span><span class="m">2</span><span class="p">]</span><span class="o">^</span><span class="m">2</span><span class="p">),</span><span class="w"> </span><span class="m">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best linear fit using forest predictions (on held-out data)
as well as the mean forest prediction as regressors, along
with one-sided heteroskedasticity-robust (HC3) SEs:

                                Estimate Std. Error t value Pr(&gt;t)    
mean.forest.prediction          1.008054   0.082129 12.2741 &lt;2e-16 ***
differential.forest.prediction -0.552783   1.063927 -0.5196 0.6983    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
</pre></div>
</div>
<div class="output text_html">'95% CI for difference in ATE: 0.01 +/- 0.074'</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">#</span>
<span class="c1"># formal test for X1 and X2</span>
<span class="c1">#</span>

<span class="n">dr.score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tau.hat</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">W</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cf</span><span class="o">$</span><span class="n">W.hat</span><span class="w"> </span><span class="o">*</span>
<span class="w">  </span><span class="p">(</span><span class="n">Y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cf</span><span class="o">$</span><span class="n">Y.hat</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="m">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cf</span><span class="o">$</span><span class="n">W.hat</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tau.hat</span><span class="p">)</span><span class="w"> </span><span class="o">-</span>
<span class="w">  </span><span class="p">(</span><span class="m">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">W</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="m">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cf</span><span class="o">$</span><span class="n">W.hat</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">Y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cf</span><span class="o">$</span><span class="n">Y.hat</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cf</span><span class="o">$</span><span class="n">W.hat</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tau.hat</span><span class="p">)</span>
<span class="n">school.score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">t</span><span class="p">(</span><span class="n">school.mat</span><span class="p">)</span><span class="w"> </span><span class="o">%*%</span><span class="w"> </span><span class="n">dr.score</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">school.size</span>

<span class="n">school.X1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">t</span><span class="p">(</span><span class="n">school.mat</span><span class="p">)</span><span class="w"> </span><span class="o">%*%</span><span class="w"> </span><span class="n">X</span><span class="o">$</span><span class="n">X1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">school.size</span>
<span class="n">high.X1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">school.X1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nf">median</span><span class="p">(</span><span class="n">school.X1</span><span class="p">)</span>
<span class="nf">t.test</span><span class="p">(</span><span class="n">school.score</span><span class="p">[</span><span class="n">high.X1</span><span class="p">],</span><span class="w"> </span><span class="n">school.score</span><span class="p">[</span><span class="o">!</span><span class="n">high.X1</span><span class="p">])</span>

<span class="n">school.X2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="n">school.mat</span><span class="p">)</span><span class="w"> </span><span class="o">%*%</span><span class="w"> </span><span class="n">X</span><span class="o">$</span><span class="n">X2</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">school.size</span>
<span class="n">high.X2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">school.X2</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nf">median</span><span class="p">(</span><span class="n">school.X2</span><span class="p">)</span>
<span class="nf">t.test</span><span class="p">(</span><span class="n">school.score</span><span class="p">[</span><span class="n">high.X2</span><span class="p">],</span><span class="w"> </span><span class="n">school.score</span><span class="p">[</span><span class="o">!</span><span class="n">high.X2</span><span class="p">])</span>

<span class="n">school.X2.levels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">cut</span><span class="p">(</span><span class="n">school.X2</span><span class="p">,</span>
<span class="w">  </span><span class="n">breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="o">-</span><span class="kc">Inf</span><span class="p">,</span><span class="w"> </span><span class="nf">quantile</span><span class="p">(</span><span class="n">school.X2</span><span class="p">,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="o">/</span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="o">/</span><span class="m">3</span><span class="p">)),</span><span class="w"> </span><span class="kc">Inf</span><span class="p">))</span>
<span class="nf">summary</span><span class="p">(</span><span class="nf">aov</span><span class="p">(</span><span class="n">school.score</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">school.X2.levels</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>	Welch Two Sample t-test

data:  school.score[high.X1] and school.score[!high.X1]
t = -3.0347, df = 71.45, p-value = 0.003357
alternative hypothesis: true difference in means is not equal to 0
95 percent confidence interval:
 -0.19218352 -0.03978437
sample estimates:
mean of x mean of y 
0.1908525 0.3068365 
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>	Welch Two Sample t-test

data:  school.score[high.X2] and school.score[!high.X2]
t = 0.9637, df = 72.286, p-value = 0.3384
alternative hypothesis: true difference in means is not equal to 0
95 percent confidence interval:
 -0.04146936  0.11909811
sample estimates:
mean of x mean of y 
0.2682517 0.2294373 
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                 Df Sum Sq Mean Sq F value Pr(&gt;F)
school.X2.levels  2 0.0811 0.04054   1.328  0.271
Residuals        73 2.2283 0.03052               
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">#</span>
<span class="c1"># formal test for S3</span>
<span class="c1">#</span>

<span class="n">school.score.XS3.high</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">t</span><span class="p">(</span><span class="n">school.mat</span><span class="p">)</span><span class="w"> </span><span class="o">%*%</span><span class="w"> </span><span class="p">(</span><span class="n">dr.score</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">X</span><span class="o">$</span><span class="n">S3</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m">6</span><span class="p">))</span><span class="w"> </span><span class="o">/</span>
<span class="w">  </span><span class="nf">t</span><span class="p">(</span><span class="n">school.mat</span><span class="p">)</span><span class="w"> </span><span class="o">%*%</span><span class="w"> </span><span class="p">(</span><span class="n">X</span><span class="o">$</span><span class="n">S3</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m">6</span><span class="p">)</span>
<span class="n">school.score.XS3.low</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">t</span><span class="p">(</span><span class="n">school.mat</span><span class="p">)</span><span class="w"> </span><span class="o">%*%</span><span class="w"> </span><span class="p">(</span><span class="n">dr.score</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">X</span><span class="o">$</span><span class="n">S3</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">6</span><span class="p">))</span><span class="w"> </span><span class="o">/</span>
<span class="w">  </span><span class="nf">t</span><span class="p">(</span><span class="n">school.mat</span><span class="p">)</span><span class="w"> </span><span class="o">%*%</span><span class="w"> </span><span class="p">(</span><span class="n">X</span><span class="o">$</span><span class="n">S3</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">6</span><span class="p">)</span>

<span class="nf">plot</span><span class="p">(</span><span class="n">school.score.XS3.low</span><span class="p">,</span><span class="w"> </span><span class="n">school.score.XS3.high</span><span class="p">)</span>
<span class="nf">t.test</span><span class="p">(</span><span class="n">school.score.XS3.high</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">school.score.XS3.low</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>	One Sample t-test

data:  school.score.XS3.high - school.score.XS3.low
t = 2.2397, df = 75, p-value = 0.02807
alternative hypothesis: true mean is not equal to 0
95 percent confidence interval:
 0.009408619 0.160803922
sample estimates:
 mean of x 
0.08510627 
</pre></div>
</div>
<img alt="_images/bf0fc93fde2d174b97d8f551fad910625482b8ec230a31f3ea025c37de3780b8.png" src="_images/bf0fc93fde2d174b97d8f551fad910625482b8ec230a31f3ea025c37de3780b8.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">#</span>
<span class="c1"># Look at school-wise heterogeneity</span>
<span class="c1">#</span>

<span class="c1">#pdf(&quot;school_hist.pdf&quot;)</span>
<span class="n">pardef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">par</span><span class="p">(</span><span class="n">mar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.lab</span><span class="o">=</span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.axis</span><span class="o">=</span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.main</span><span class="o">=</span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.sub</span><span class="o">=</span><span class="m">1.5</span><span class="p">)</span>
<span class="nf">hist</span><span class="p">(</span><span class="n">school.score</span><span class="p">,</span><span class="w"> </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;School Treatment Effect Estimate&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="c1">#dev.off()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d9682d702a83a3072b53443ba30bccd7d8375d53006e0ba7d23acebde6fd2df2.png" src="_images/d9682d702a83a3072b53443ba30bccd7d8375d53006e0ba7d23acebde6fd2df2.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">#</span>
<span class="c1"># Re-check ATE... sanity check only</span>
<span class="c1">#</span>

<span class="n">ate.hat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">mean</span><span class="p">(</span><span class="n">school.score</span><span class="p">)</span>
<span class="n">se.hat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sqrt</span><span class="p">(</span><span class="nf">var</span><span class="p">(</span><span class="n">school.score</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">school.score</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">paste</span><span class="p">(</span><span class="nf">round</span><span class="p">(</span><span class="n">ate.hat</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;+/-&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="m">1.96</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">se.hat</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1] &quot;0.249 +/- 0.039&quot;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">#</span>
<span class="c1"># Look at variation in propensity scores</span>
<span class="c1">#</span>

<span class="n">DF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">X</span>
<span class="n">DF</span><span class="o">$</span><span class="n">W.hat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cf</span><span class="o">$</span><span class="n">W.hat</span>

<span class="c1">#pdf(&quot;pscore.pdf&quot;)</span>
<span class="n">pardef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">par</span><span class="p">(</span><span class="n">mar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.lab</span><span class="o">=</span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.axis</span><span class="o">=</span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.main</span><span class="o">=</span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.sub</span><span class="o">=</span><span class="m">1.5</span><span class="p">)</span>
<span class="nf">boxplot</span><span class="p">(</span><span class="n">W.hat</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">S3</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DF</span><span class="p">,</span><span class="w"> </span><span class="n">ylab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Propensity Score&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Student Expectation of Success&quot;</span><span class="p">)</span>
<span class="nf">lines</span><span class="p">(</span><span class="nf">smooth.spline</span><span class="p">(</span><span class="n">X</span><span class="o">$</span><span class="n">S3</span><span class="p">,</span><span class="w"> </span><span class="n">cf</span><span class="o">$</span><span class="n">W.hat</span><span class="p">),</span><span class="w"> </span><span class="n">lwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">)</span>
<span class="c1">#dev.off()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d9ee56fc8decb4df55bfa386dff091897336f0ec211a995948017ad39115c386.png" src="_images/d9ee56fc8decb4df55bfa386dff091897336f0ec211a995948017ad39115c386.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">#</span>
<span class="c1"># Analysis ignoring clusters</span>
<span class="c1">#</span>

<span class="n">cf.noclust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">causal_forest</span><span class="p">(</span><span class="n">X</span><span class="p">[,</span><span class="n">selected.idx</span><span class="p">],</span><span class="w"> </span><span class="n">Y</span><span class="p">,</span><span class="w"> </span><span class="n">W</span><span class="p">,</span>
<span class="w">                           </span><span class="n">Y.hat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Y.hat</span><span class="p">,</span><span class="w"> </span><span class="n">W.hat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">W.hat</span><span class="p">,</span>
<span class="w">                           </span><span class="n">tune.parameters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;all&quot;</span><span class="p">)</span>

<span class="n">ATE.noclust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">average_treatment_effect</span><span class="p">(</span><span class="n">cf.noclust</span><span class="p">)</span>
<span class="nf">paste</span><span class="p">(</span><span class="s">&quot;95% CI for the ATE:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="n">ATE.noclust</span><span class="p">[</span><span class="m">1</span><span class="p">],</span><span class="w"> </span><span class="m">3</span><span class="p">),</span>
<span class="w">      </span><span class="s">&quot;+/-&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="nf">qnorm</span><span class="p">(</span><span class="m">0.975</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ATE.noclust</span><span class="p">[</span><span class="m">2</span><span class="p">],</span><span class="w"> </span><span class="m">3</span><span class="p">))</span>

<span class="nf">test_calibration</span><span class="p">(</span><span class="n">cf.noclust</span><span class="p">)</span>

<span class="n">tau.hat.noclust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="n">cf.noclust</span><span class="p">)</span><span class="o">$</span><span class="n">predict</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">school.id</span><span class="p">,</span><span class="w"> </span><span class="n">tau.hat.noclust</span><span class="p">)</span>

<span class="n">nfold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span>
<span class="n">school.levels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">unique</span><span class="p">(</span><span class="n">school.id</span><span class="p">)</span>
<span class="n">cluster.folds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sample.int</span><span class="p">(</span><span class="n">nfold</span><span class="p">,</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">school.levels</span><span class="p">),</span><span class="w"> </span><span class="n">replace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span>

<span class="n">tau.hat.crossfold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">Y</span><span class="p">))</span>
<span class="nf">for </span><span class="p">(</span><span class="n">foldid</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">nfold</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nf">print</span><span class="p">(</span><span class="n">foldid</span><span class="p">)</span>
<span class="w">  </span><span class="n">infold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">school.id</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">school.levels</span><span class="p">[</span><span class="n">cluster.folds</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">foldid</span><span class="p">]</span>
<span class="w">  </span><span class="n">cf.fold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">causal_forest</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="o">!</span><span class="n">infold</span><span class="p">,</span><span class="w"> </span><span class="n">selected.idx</span><span class="p">],</span><span class="w"> </span><span class="n">Y</span><span class="p">[</span><span class="o">!</span><span class="n">infold</span><span class="p">],</span><span class="w"> </span><span class="n">W</span><span class="p">[</span><span class="o">!</span><span class="n">infold</span><span class="p">],</span>
<span class="w">                          </span><span class="n">Y.hat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Y.hat</span><span class="p">[</span><span class="o">!</span><span class="n">infold</span><span class="p">],</span><span class="w"> </span><span class="n">W.hat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">W.hat</span><span class="p">[</span><span class="o">!</span><span class="n">infold</span><span class="p">],</span>
<span class="w">                          </span><span class="n">tune.parameters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;all&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="n">pred.fold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="n">cf.fold</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">[</span><span class="n">infold</span><span class="p">,</span><span class="w"> </span><span class="n">selected.idx</span><span class="p">])</span><span class="o">$</span><span class="n">predictions</span>
<span class="w">  </span><span class="n">tau.hat.crossfold</span><span class="p">[</span><span class="n">infold</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pred.fold</span>
<span class="p">}</span>

<span class="n">cf.noclust.cpy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cf.noclust</span>
<span class="n">cf.noclust.cpy</span><span class="o">$</span><span class="n">predictions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tau.hat.crossfold</span>
<span class="n">cf.noclust.cpy</span><span class="o">$</span><span class="n">clusters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">school.id</span>
<span class="nf">test_calibration</span><span class="p">(</span><span class="n">cf.noclust.cpy</span><span class="p">)</span>

<span class="n">Rloss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">mean</span><span class="p">(((</span><span class="n">Y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Y.hat</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tau.hat</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">W</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">W.hat</span><span class="p">))</span><span class="o">^</span><span class="m">2</span><span class="p">)</span>
<span class="n">Rloss.noclust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">mean</span><span class="p">(((</span><span class="n">Y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Y.hat</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tau.hat.noclust</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">W</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">W.hat</span><span class="p">))</span><span class="o">^</span><span class="m">2</span><span class="p">)</span>
<span class="n">Rloss.crossfold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">mean</span><span class="p">(((</span><span class="n">Y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Y.hat</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tau.hat.crossfold</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">W</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">W.hat</span><span class="p">))</span><span class="o">^</span><span class="m">2</span><span class="p">)</span>

<span class="nf">c</span><span class="p">(</span><span class="n">Rloss.noclust</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Rloss</span><span class="p">,</span><span class="w"> </span><span class="n">Rloss.crossfold</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Rloss</span><span class="p">)</span>

<span class="nf">summary</span><span class="p">(</span><span class="nf">aov</span><span class="p">(</span><span class="n">dr.score</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="nf">factor</span><span class="p">(</span><span class="n">school.id</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">'95% CI for the ATE: 0.254 +/- 0.022'</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best linear fit using forest predictions (on held-out data)
as well as the mean forest prediction as regressors, along
with one-sided heteroskedasticity-robust (HC3) SEs:

                               Estimate Std. Error t value    Pr(&gt;t)    
mean.forest.prediction         1.012757   0.045084 22.4639 &lt; 2.2e-16 ***
differential.forest.prediction 0.528275   0.133245  3.9647 3.699e-05 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1] 1
[1] 2
[1] 3
[1] 4
[1] 5
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best linear fit using forest predictions (on held-out data)
as well as the mean forest prediction as regressors, along
with one-sided heteroskedasticity-robust (HC3) SEs:

                               Estimate Std. Error t value Pr(&gt;t)    
mean.forest.prediction         0.988134   0.064817 15.2450 &lt;2e-16 ***
differential.forest.prediction 0.224634   0.213643  1.0514 0.1465    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
</pre></div>
</div>
<div class="output text_html"><ol class=list-inline>
	<li>-8.91498516542577e-05</li>
	<li>0.000504054002137821</li>
</ol>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                     Df Sum Sq Mean Sq F value   Pr(&gt;F)    
factor(school.id)    75    201   2.677    1.98 1.05e-06 ***
Residuals         10315  13944   1.352                     
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
</pre></div>
</div>
<img alt="_images/699d3667be0de6639256c044e2335a5c5ea2cb5b813a68744ffcdd0d81867bb2.png" src="_images/699d3667be0de6639256c044e2335a5c5ea2cb5b813a68744ffcdd0d81867bb2.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">#</span>
<span class="c1"># Analaysis without fitting the propensity score</span>
<span class="c1">#</span>

<span class="n">cf.noprop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">causal_forest</span><span class="p">(</span><span class="n">X</span><span class="p">[,</span><span class="n">selected.idx</span><span class="p">],</span><span class="w"> </span><span class="n">Y</span><span class="p">,</span><span class="w"> </span><span class="n">W</span><span class="p">,</span>
<span class="w">                          </span><span class="n">Y.hat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Y.hat</span><span class="p">,</span><span class="w"> </span><span class="n">W.hat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">mean</span><span class="p">(</span><span class="n">W</span><span class="p">),</span>
<span class="w">                          </span><span class="n">tune.parameters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;all&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="n">equalize.cluster.weights</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span>
<span class="w">                          </span><span class="n">clusters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">school.id</span><span class="p">)</span>
<span class="n">tau.hat.noprop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="n">cf.noprop</span><span class="p">)</span><span class="o">$</span><span class="n">predictions</span>

<span class="n">ATE.noprop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">average_treatment_effect</span><span class="p">(</span><span class="n">cf.noprop</span><span class="p">)</span>
<span class="nf">paste</span><span class="p">(</span><span class="s">&quot;95% CI for the ATE:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="n">ATE.noprop</span><span class="p">[</span><span class="m">1</span><span class="p">],</span><span class="w"> </span><span class="m">3</span><span class="p">),</span>
<span class="w">      </span><span class="s">&quot;+/-&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="nf">qnorm</span><span class="p">(</span><span class="m">0.975</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ATE.noprop</span><span class="p">[</span><span class="m">2</span><span class="p">],</span><span class="w"> </span><span class="m">3</span><span class="p">))</span>

<span class="c1">#pdf(&quot;tauhat_noprop.pdf&quot;)</span>
<span class="n">pardef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">par</span><span class="p">(</span><span class="n">mar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.lab</span><span class="o">=</span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.axis</span><span class="o">=</span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.main</span><span class="o">=</span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.sub</span><span class="o">=</span><span class="m">1.5</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">tau.hat</span><span class="p">,</span><span class="w"> </span><span class="n">tau.hat.noprop</span><span class="p">,</span>
<span class="w">     </span><span class="n">xlim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">range</span><span class="p">(</span><span class="n">tau.hat</span><span class="p">,</span><span class="w"> </span><span class="n">tau.hat.noprop</span><span class="p">),</span>
<span class="w">     </span><span class="n">ylim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">range</span><span class="p">(</span><span class="n">tau.hat</span><span class="p">,</span><span class="w"> </span><span class="n">tau.hat.noprop</span><span class="p">),</span>
<span class="w">     </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;orthogonalized causal forest estimates&quot;</span><span class="p">,</span>
<span class="w">     </span><span class="n">ylab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;non-orthogonalized causal forest&quot;</span><span class="p">)</span>
<span class="nf">abline</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">lwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">lty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">)</span>
<span class="n">par</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pardef</span>
<span class="c1">#dev.off()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">'95% CI for the ATE: 0.255 +/- 0.041'</div><img alt="_images/71d2fee3dd2f409b8262b3868ffd053c78af177a0dc74eadc60fffb3e8bab643.png" src="_images/71d2fee3dd2f409b8262b3868ffd053c78af177a0dc74eadc60fffb3e8bab643.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">#</span>
<span class="c1"># Train forest on school-wise DR scores</span>
<span class="c1">#</span>

<span class="n">school.X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="n">school.mat</span><span class="p">)</span><span class="w"> </span><span class="o">%*%</span><span class="w"> </span><span class="nf">as.matrix</span><span class="p">(</span><span class="n">X</span><span class="p">[,</span><span class="nf">c</span><span class="p">(</span><span class="m">4</span><span class="o">:</span><span class="m">8</span><span class="p">,</span><span class="w"> </span><span class="m">25</span><span class="o">:</span><span class="m">28</span><span class="p">)]))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">school.size</span>
<span class="n">school.X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">data.frame</span><span class="p">(</span><span class="n">school.X</span><span class="p">)</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">school.X</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;X1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;X2&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;X3&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;X4&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;X5&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="s">&quot;XC.1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;XC.2&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;XC.3&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;XC.4&quot;</span><span class="p">)</span>

<span class="n">dr.score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tau.hat</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">W</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cf</span><span class="o">$</span><span class="n">W.hat</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">Y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cf</span><span class="o">$</span><span class="n">Y.hat</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="m">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cf</span><span class="o">$</span><span class="n">W.hat</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tau.hat</span><span class="p">)</span><span class="w"> </span><span class="o">-</span>
<span class="w">  </span><span class="p">(</span><span class="m">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">W</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="m">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cf</span><span class="o">$</span><span class="n">W.hat</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">Y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cf</span><span class="o">$</span><span class="n">Y.hat</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cf</span><span class="o">$</span><span class="n">W.hat</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tau.hat</span><span class="p">)</span>
<span class="n">school.score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">t</span><span class="p">(</span><span class="n">school.mat</span><span class="p">)</span><span class="w"> </span><span class="o">%*%</span><span class="w"> </span><span class="n">dr.score</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">school.size</span>

<span class="n">school.forest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">regression_forest</span><span class="p">(</span><span class="n">school.X</span><span class="p">,</span><span class="w"> </span><span class="n">school.score</span><span class="p">)</span>
<span class="n">school.pred</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="n">school.forest</span><span class="p">)</span><span class="o">$</span><span class="n">predictions</span>
<span class="nf">test_calibration</span><span class="p">(</span><span class="n">school.forest</span><span class="p">)</span>


<span class="c1"># Alternative OLS analysis</span>
<span class="n">school.DF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">data.frame</span><span class="p">(</span><span class="n">school.X</span><span class="p">,</span><span class="w"> </span><span class="n">school.score</span><span class="o">=</span><span class="n">school.score</span><span class="p">)</span>
<span class="nf">coeftest</span><span class="p">(</span><span class="nf">lm</span><span class="p">(</span><span class="n">school.score</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">.</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">school.DF</span><span class="p">),</span><span class="w"> </span><span class="n">vcov</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vcovHC</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best linear fit using forest predictions (on held-out data)
as well as the mean forest prediction as regressors, along
with one-sided heteroskedasticity-robust (HC3) SEs:

                               Estimate Std. Error t value Pr(&gt;t)    
mean.forest.prediction          1.00004    0.08179 12.2269 &lt;2e-16 ***
differential.forest.prediction  0.71717    0.67983  1.0549 0.1474    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>t test of coefficients:

              Estimate Std. Error t value Pr(&gt;|t|)   
(Intercept)  0.2414116  0.0770612  3.1327 0.002583 **
X1          -0.0506340  0.0291568 -1.7366 0.087121 . 
X2           0.0125656  0.0336563  0.3734 0.710084   
X3           0.0102119  0.0266019  0.3839 0.702302   
X4           0.0236645  0.0255092  0.9277 0.356950   
X5          -0.0357828  0.0268560 -1.3324 0.187312   
XC.1         0.0015231  0.0935067  0.0163 0.987054   
XC.2         0.0887259  0.1047433  0.8471 0.400012   
XC.3        -0.1341513  0.0875327 -1.5326 0.130158   
XC.4         0.0424028  0.0816170  0.5195 0.605127   
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">#</span>
<span class="c1"># Make some plots...</span>
<span class="c1">#</span>

<span class="c1">#pdf(&quot;tauhat_hist.pdf&quot;)</span>
<span class="n">pardef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">par</span><span class="p">(</span><span class="n">mar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.lab</span><span class="o">=</span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.axis</span><span class="o">=</span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.main</span><span class="o">=</span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.sub</span><span class="o">=</span><span class="m">1.5</span><span class="p">)</span>
<span class="nf">hist</span><span class="p">(</span><span class="n">tau.hat</span><span class="p">,</span><span class="w"> </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;estimated CATE&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="c1">#dev.off()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/2f9455533a6d12efcf59ed49601927658a329638b98c36e8d47f0635a810c71a.png" src="_images/2f9455533a6d12efcf59ed49601927658a329638b98c36e8d47f0635a810c71a.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">#pdf(&quot;tauhat_hist_noprop.pdf&quot;)</span>
<span class="n">pardef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">par</span><span class="p">(</span><span class="n">mar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.lab</span><span class="o">=</span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.axis</span><span class="o">=</span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.main</span><span class="o">=</span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.sub</span><span class="o">=</span><span class="m">1.5</span><span class="p">)</span>
<span class="nf">hist</span><span class="p">(</span><span class="n">tau.hat.noprop</span><span class="p">,</span><span class="w"> </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;estimated CATE&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="c1">#dev.off()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/a7a62d6f2797cc3bc776967ff6664768665e2e8e2cd7837578e9262eaf3feaad.png" src="_images/a7a62d6f2797cc3bc776967ff6664768665e2e8e2cd7837578e9262eaf3feaad.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">#pdf(&quot;tauhat_hist_noclust.pdf&quot;)</span>
<span class="n">pardef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">par</span><span class="p">(</span><span class="n">mar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.lab</span><span class="o">=</span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.axis</span><span class="o">=</span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.main</span><span class="o">=</span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.sub</span><span class="o">=</span><span class="m">1.5</span><span class="p">)</span>
<span class="nf">hist</span><span class="p">(</span><span class="n">tau.hat.noclust</span><span class="p">,</span><span class="w"> </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;estimated CATE&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span>
<span class="w">     </span><span class="n">breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">seq</span><span class="p">(</span><span class="m">-0.0</span><span class="p">,</span><span class="w"> </span><span class="m">0.55</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.55</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">25</span><span class="p">))</span>
<span class="c1">#dev.off()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e9eb4f892e071fb905532b91c282f8460046ba5c31ef3dd58681ec73eeaf301e.png" src="_images/e9eb4f892e071fb905532b91c282f8460046ba5c31ef3dd58681ec73eeaf301e.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">#pdf(&quot;tauhat_vs_X1.pdf&quot;)</span>
<span class="n">pardef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">par</span><span class="p">(</span><span class="n">mar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.lab</span><span class="o">=</span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.axis</span><span class="o">=</span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.main</span><span class="o">=</span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.sub</span><span class="o">=</span><span class="m">1.5</span><span class="p">)</span>
<span class="nf">boxplot</span><span class="p">(</span><span class="n">tau.hat</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="n">X</span><span class="o">$</span><span class="n">X1</span><span class="p">),</span><span class="w"> </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;X1&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ylab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;estimated CATE&quot;</span><span class="p">)</span>
<span class="nf">lines</span><span class="p">(</span><span class="nf">smooth.spline</span><span class="p">(</span><span class="m">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">X</span><span class="p">[,</span><span class="s">&quot;X1&quot;</span><span class="p">],</span><span class="w"> </span><span class="n">tau.hat</span><span class="p">,</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">),</span><span class="w"> </span><span class="n">lwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">)</span>
<span class="c1">#dev.off()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/532f9b07f93363309617d990bcdf340a358b2eb99608cda2cf4ec35c888df9ce.png" src="_images/532f9b07f93363309617d990bcdf340a358b2eb99608cda2cf4ec35c888df9ce.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">#pdf(&quot;tauhat_vs_X2.pdf&quot;)</span>
<span class="n">pardef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">par</span><span class="p">(</span><span class="n">mar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.lab</span><span class="o">=</span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.axis</span><span class="o">=</span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.main</span><span class="o">=</span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.sub</span><span class="o">=</span><span class="m">1.5</span><span class="p">)</span>
<span class="nf">boxplot</span><span class="p">(</span><span class="n">tau.hat</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="n">X</span><span class="o">$</span><span class="n">X2</span><span class="p">),</span><span class="w"> </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;X2&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ylab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;estimated CATE&quot;</span><span class="p">)</span>
<span class="nf">lines</span><span class="p">(</span><span class="nf">smooth.spline</span><span class="p">(</span><span class="m">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">X</span><span class="p">[,</span><span class="s">&quot;X2&quot;</span><span class="p">],</span><span class="w"> </span><span class="n">tau.hat</span><span class="p">,</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">),</span><span class="w"> </span><span class="n">lwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">)</span>
<span class="c1">#dev.off()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d521d9e297e38db51a16b25a51d5fe30b64b0006b39e0ed29bc4bb5ac949575c.png" src="_images/d521d9e297e38db51a16b25a51d5fe30b64b0006b39e0ed29bc4bb5ac949575c.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">school.avg.tauhat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">t</span><span class="p">(</span><span class="n">school.mat</span><span class="p">)</span><span class="w"> </span><span class="o">%*%</span><span class="w"> </span><span class="n">tau.hat</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">school.size</span>

<span class="c1">#pdf(&quot;school_avg.pdf&quot;)</span>
<span class="n">pardef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">par</span><span class="p">(</span><span class="n">mar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.lab</span><span class="o">=</span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.axis</span><span class="o">=</span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.main</span><span class="o">=</span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.sub</span><span class="o">=</span><span class="m">1.5</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">school.avg.tauhat</span><span class="p">,</span><span class="w"> </span><span class="n">school.pred</span><span class="p">,</span><span class="w"> </span><span class="n">cex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.5</span><span class="p">,</span>
<span class="w">     </span><span class="n">xlim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">range</span><span class="p">(</span><span class="n">school.avg.tauhat</span><span class="p">,</span><span class="w"> </span><span class="n">school.pred</span><span class="p">),</span>
<span class="w">     </span><span class="n">ylim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">range</span><span class="p">(</span><span class="n">school.avg.tauhat</span><span class="p">,</span><span class="w"> </span><span class="n">school.pred</span><span class="p">),</span>
<span class="w">     </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;average CATE estimate in school&quot;</span><span class="p">,</span>
<span class="w">     </span><span class="n">ylab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;school-wise forest predictions&quot;</span><span class="p">)</span>
<span class="nf">abline</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">lwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">lty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">)</span>
<span class="n">par</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pardef</span>
<span class="c1">#dev.off()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/41fe92c7757cfd0c1c5ee25e967fc1aa24a06ed309ae489b8c2116cb84d65f1a.png" src="_images/41fe92c7757cfd0c1c5ee25e967fc1aa24a06ed309ae489b8c2116cb84d65f1a.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">#</span>
<span class="c1"># Experiment with no orthogonalization</span>
<span class="c1">#</span>

<span class="n">n.synth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1000</span>
<span class="n">p.synth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span>
<span class="n">X.synth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">matrix</span><span class="p">(</span><span class="nf">rnorm</span><span class="p">(</span><span class="n">n.synth</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">p.synth</span><span class="p">),</span><span class="w"> </span><span class="n">n.synth</span><span class="p">,</span><span class="w"> </span><span class="n">p.synth</span><span class="p">)</span>
<span class="n">W.synth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">rbinom</span><span class="p">(</span><span class="n">n.synth</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="m">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">exp</span><span class="p">(</span><span class="o">-</span><span class="n">X.synth</span><span class="p">[,</span><span class="m">1</span><span class="p">])))</span>
<span class="n">Y.synth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">rowMeans</span><span class="p">(</span><span class="n">X.synth</span><span class="p">[,</span><span class="m">1</span><span class="o">:</span><span class="m">6</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">rnorm</span><span class="p">(</span><span class="n">n.synth</span><span class="p">)</span>

<span class="n">Y.forest.synth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">regression_forest</span><span class="p">(</span><span class="n">X.synth</span><span class="p">,</span><span class="w"> </span><span class="n">Y.synth</span><span class="p">)</span>
<span class="n">Y.hat.synth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="n">Y.forest.synth</span><span class="p">)</span><span class="o">$</span><span class="n">predictions</span>
<span class="n">W.forest.synth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">regression_forest</span><span class="p">(</span><span class="n">X.synth</span><span class="p">,</span><span class="w"> </span><span class="n">W.synth</span><span class="p">)</span>
<span class="n">W.hat.synth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="n">W.forest.synth</span><span class="p">)</span><span class="o">$</span><span class="n">predictions</span>

<span class="n">cf.synth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">causal_forest</span><span class="p">(</span><span class="n">X.synth</span><span class="p">,</span><span class="w"> </span><span class="n">Y.synth</span><span class="p">,</span><span class="w"> </span><span class="n">W.synth</span><span class="p">,</span>
<span class="w">                         </span><span class="n">Y.hat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Y.hat.synth</span><span class="p">,</span><span class="w"> </span><span class="n">W.hat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">W.hat.synth</span><span class="p">)</span>
<span class="n">ATE.synth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">average_treatment_effect</span><span class="p">(</span><span class="n">cf.synth</span><span class="p">)</span>
<span class="nf">paste</span><span class="p">(</span><span class="s">&quot;95% CI for the ATE:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="n">ATE.synth</span><span class="p">[</span><span class="m">1</span><span class="p">],</span><span class="w"> </span><span class="m">3</span><span class="p">),</span>
<span class="w">      </span><span class="s">&quot;+/-&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="nf">qnorm</span><span class="p">(</span><span class="m">0.975</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ATE.synth</span><span class="p">[</span><span class="m">2</span><span class="p">],</span><span class="w"> </span><span class="m">3</span><span class="p">))</span>

<span class="n">cf.synth.noprop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">causal_forest</span><span class="p">(</span><span class="n">X.synth</span><span class="p">,</span><span class="w"> </span><span class="n">Y.synth</span><span class="p">,</span><span class="w"> </span><span class="n">W.synth</span><span class="p">,</span>
<span class="w">                                </span><span class="n">Y.hat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Y.hat.synth</span><span class="p">,</span><span class="w"> </span><span class="n">W.hat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">mean</span><span class="p">(</span><span class="n">W.synth</span><span class="p">))</span>
<span class="n">ATE.synth.noprop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">average_treatment_effect</span><span class="p">(</span><span class="n">cf.synth.noprop</span><span class="p">)</span>
<span class="nf">paste</span><span class="p">(</span><span class="s">&quot;95% CI for the ATE:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="n">ATE.synth.noprop</span><span class="p">[</span><span class="m">1</span><span class="p">],</span><span class="w"> </span><span class="m">3</span><span class="p">),</span>
<span class="w">      </span><span class="s">&quot;+/-&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="nf">qnorm</span><span class="p">(</span><span class="m">0.975</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ATE.synth.noprop</span><span class="p">[</span><span class="m">2</span><span class="p">],</span><span class="w"> </span><span class="m">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">'95% CI for the ATE: 0.01 +/- 0.15'</div><div class="output text_html">'95% CI for the ATE: 0.13 +/- 0.137'</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">#</span>
<span class="c1"># Visualize school-level covariates by treatment heterogeneity</span>
<span class="c1">#</span>

<span class="n">school.X.std</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">scale</span><span class="p">(</span><span class="n">school.X</span><span class="p">)</span>
<span class="n">school.tercile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">cut</span><span class="p">(</span><span class="n">school.pred</span><span class="p">,</span>
<span class="w">                     </span><span class="n">breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="o">-</span><span class="kc">Inf</span><span class="p">,</span><span class="w"> </span><span class="nf">quantile</span><span class="p">(</span><span class="n">school.pred</span><span class="p">,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="o">/</span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="o">/</span><span class="m">3</span><span class="p">)),</span><span class="w"> </span><span class="kc">Inf</span><span class="p">))</span>
<span class="n">school.tercile.mat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">model.matrix</span><span class="p">(</span><span class="o">~</span><span class="w"> </span><span class="n">school.tercile</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">0</span><span class="p">)</span>
<span class="n">school.means</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">diag</span><span class="p">(</span><span class="m">1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">colSums</span><span class="p">(</span><span class="n">school.tercile.mat</span><span class="p">))</span><span class="w"> </span><span class="o">%*%</span><span class="w"> </span><span class="nf">t</span><span class="p">(</span><span class="n">school.tercile.mat</span><span class="p">)</span><span class="w"> </span><span class="o">%*%</span><span class="w"> </span><span class="nf">as.matrix</span><span class="p">(</span><span class="n">school.X.std</span><span class="p">)</span>

<span class="n">MM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">school.means</span><span class="p">))</span>
<span class="n">HC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">heat.colors</span><span class="p">(</span><span class="m">21</span><span class="p">)</span>
<span class="n">school.col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">school.means</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span><span class="w"> </span><span class="n">HC</span><span class="p">[</span><span class="m">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="m">20</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="m">0.5</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">aa</span><span class="p">))])</span>

<span class="n">DF.plot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">data.frame</span><span class="p">(</span><span class="n">tercile</span><span class="o">=</span><span class="nf">rep</span><span class="p">(</span><span class="nf">factor</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="n">labels</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;low&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mid&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;high&quot;</span><span class="p">)),</span><span class="w"> </span><span class="m">9</span><span class="p">),</span><span class="w"> </span><span class="n">mean</span><span class="o">=</span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">school.means</span><span class="p">),</span>
<span class="w">                     </span><span class="n">feature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">factor</span><span class="p">(</span><span class="nf">rbind</span><span class="p">(</span><span class="nf">colnames</span><span class="p">(</span><span class="n">school.X</span><span class="p">),</span><span class="w"> </span><span class="nf">colnames</span><span class="p">(</span><span class="n">school.X</span><span class="p">),</span><span class="w"> </span><span class="nf">colnames</span><span class="p">(</span><span class="n">school.X</span><span class="p">))))</span>

<span class="nf">ggplot</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DF.plot</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">feature</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tercile</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">))</span><span class="w"> </span><span class="o">+</span>
<span class="w">    </span><span class="nf">geom_tile</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">scale_fill_gradient</span><span class="p">(</span><span class="n">low</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;white&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;steelblue&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">    </span><span class="nf">theme</span><span class="p">(</span><span class="n">axis.text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">12</span><span class="p">),</span><span class="w"> </span><span class="n">axis.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">14</span><span class="p">),</span>
<span class="w">          </span><span class="n">legend.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">14</span><span class="p">),</span><span class="w"> </span><span class="n">legend.text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">12</span><span class="p">))</span><span class="w"> </span><span class="o">+</span>
<span class="w">    </span><span class="nf">theme</span><span class="p">(</span><span class="n">panel.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">())</span>
<span class="c1">#ggsave(&quot;tercile_plot.pdf&quot;, width = 8, height = 4.5, dpi = 120)</span>

<span class="nf">mean</span><span class="p">(</span><span class="n">school.X</span><span class="o">$</span><span class="n">XC.3</span><span class="p">)</span>
<span class="nf">mean</span><span class="p">(</span><span class="n">school.X</span><span class="o">$</span><span class="n">XC.3</span><span class="p">[</span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">school.tercile</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">0.210526315789474</div><div class="output text_html">0.538461538461538</div><img alt="_images/0cecf9fa1d6b7c006a17290462c735df174066c06d91d33e9b6222afeb23f257.png" src="_images/0cecf9fa1d6b7c006a17290462c735df174066c06d91d33e9b6222afeb23f257.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">#</span>
<span class="c1"># CATE by school</span>
<span class="c1">#</span>

<span class="n">ord</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">order</span><span class="p">(</span><span class="nf">order</span><span class="p">(</span><span class="n">school.pred</span><span class="p">))</span>
<span class="n">school.sort</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ord</span><span class="p">[</span><span class="n">school.id</span><span class="p">]</span>

<span class="c1">#pdf(&quot;school_boxplot.pdf&quot;)</span>
<span class="n">pardef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">par</span><span class="p">(</span><span class="n">mar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.lab</span><span class="o">=</span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.axis</span><span class="o">=</span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.main</span><span class="o">=</span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="n">cex.sub</span><span class="o">=</span><span class="m">1.5</span><span class="p">)</span>
<span class="nf">boxplot</span><span class="p">(</span><span class="n">tau.hat.noclust</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">school.sort</span><span class="p">,</span><span class="w"> </span><span class="n">xaxt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;n&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;school&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ylab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;estimated CATE&quot;</span><span class="p">)</span>
<span class="nf">points</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">76</span><span class="p">,</span><span class="w"> </span><span class="nf">sort</span><span class="p">(</span><span class="n">school.pred</span><span class="p">),</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="n">pch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">16</span><span class="p">)</span>
<span class="nf">legend</span><span class="p">(</span><span class="s">&quot;topleft&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;school mean CATE&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;CATE w/o clustering&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">pch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">16</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="w"> </span><span class="n">cex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.5</span><span class="p">)</span>
<span class="n">par</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pardef</span>
<span class="c1">#dev.off()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/cc2a110e64ea808cdbe43097cb92dcc5a516d13338adfa4ae72a99b80e428db8.png" src="_images/cc2a110e64ea808cdbe43097cb92dcc5a516d13338adfa4ae72a99b80e428db8.png" />
</div>
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "r"
        },
        kernelOptions: {
            name: "ir",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'ir'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="09-10-future-employment.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">The future of employment</p>
      </div>
    </a>
    <a class="right-next"
       href="09-11-neural-network-intro.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">第七章 神经网络与深度学习</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Cheng-Jun Wang
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>